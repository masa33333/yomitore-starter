<\!DOCTYPE html>
<html>
<head>
    <title>ãƒ¡ãƒ¼ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ãƒãƒƒã‚°</title>
    <style>
        body { font-family: 'Arial', sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .debug-info { background: #f8f9fa; font-family: monospace; padding: 10px; border-radius: 3px; white-space: pre-wrap; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .result { margin-top: 10px; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“¬ ãƒ¡ãƒ¼ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</h1>
        
        <div class="section">
            <h2>ğŸ“Š ç¾åœ¨ã®çŠ¶æ…‹</h2>
            <button onclick="checkCurrentStatus()">çŠ¶æ…‹ç¢ºèª</button>
            <div id="status-result" class="result"></div>
        </div>

        <div class="section">
            <h2>ğŸ“® ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ¥ãƒ¼</h2>
            <button onclick="checkMessageQueue()">ã‚­ãƒ¥ãƒ¼ç¢ºèª</button>
            <button onclick="clearMessageQueue()">ã‚­ãƒ¥ãƒ¼ã‚¯ãƒªã‚¢</button>
            <div id="queue-result" class="result"></div>
        </div>

        <div class="section">
            <h2>ğŸ§ª 300èªãƒ†ã‚¹ãƒˆ</h2>
            <button onclick="test300Words()">300èªã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ</button>
            <button onclick="force300Mail()">300èªãƒ¡ãƒ¼ãƒ«å¼·åˆ¶é€ä¿¡</button>
            <div id="test-result" class="result"></div>
        </div>

        <div class="section">
            <h2>ğŸ”§ ãƒ¡ãƒ¼ãƒ«æ‰‹å‹•ãƒ†ã‚¹ãƒˆ</h2>
            <input type="number" id="word-input" placeholder="èªæ•°ã‚’å…¥åŠ›" value="300" style="padding: 8px; margin: 5px;">
            <button onclick="testWordCount()">æŒ‡å®šèªæ•°ã§ãƒ†ã‚¹ãƒˆ</button>
            <div id="manual-result" class="result"></div>
        </div>

        <div class="section">
            <h2>ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</h2>
            <button onclick="resetAll()" style="background: #dc3545;">å…¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</button>
            <div id="reset-result" class="result"></div>
        </div>
    </div>

    <script>
        function checkCurrentStatus() {
            const resultDiv = document.getElementById('status-result');
            try {
                // LocalStorage data
                const userProgress = JSON.parse(localStorage.getItem('userProgress') || '{}');
                const totalWordsRead = localStorage.getItem('totalWordsRead') || '0';
                const wordCountTotal = localStorage.getItem('wordCountTotal') || '0';
                
                const info = \`
ğŸ“Š ç¾åœ¨ã®èªæ•°ãƒ‡ãƒ¼ã‚¿:
- userProgress.totalWords: \${userProgress.totalWords || 'ãªã—'}
- totalWordsRead: \${totalWordsRead}
- wordCountTotal: \${wordCountTotal}

ğŸ“ ãã®ä»–ã®ãƒ‡ãƒ¼ã‚¿:
- catName: \${localStorage.getItem('catName') || 'ãªã—'}
- vocabLevel: \${localStorage.getItem('vocabLevel') || 'ãªã—'}
                \`;
                
                resultDiv.className = 'result success';
                resultDiv.innerHTML = \`<div class="debug-info">\${info}</div>\`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = \`ã‚¨ãƒ©ãƒ¼: \${error.message}\`;
            }
        }

        function checkMessageQueue() {
            const resultDiv = document.getElementById('queue-result');
            try {
                const queue = JSON.parse(localStorage.getItem('messageQueue') || '[]');
                const info = \`
ğŸ“¬ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ¥ãƒ¼:
- ã‚­ãƒ¥ãƒ¼å†…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°: \${queue.length}
- å†…å®¹: \${JSON.stringify(queue, null, 2)}
                \`;
                
                resultDiv.className = queue.length > 0 ? 'result success' : 'result warning';
                resultDiv.innerHTML = \`<div class="debug-info">\${info}</div>\`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = \`ã‚¨ãƒ©ãƒ¼: \${error.message}\`;
            }
        }

        function clearMessageQueue() {
            const resultDiv = document.getElementById('queue-result');
            localStorage.removeItem('messageQueue');
            resultDiv.className = 'result success';
            resultDiv.textContent = 'âœ… ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ';
        }

        function test300Words() {
            const resultDiv = document.getElementById('test-result');
            try {
                // 300èªã‚’userProgressã«è¨­å®š
                const userProgress = { totalWords: 300, totalStamps: 1 };
                localStorage.setItem('userProgress', JSON.stringify(userProgress));
                localStorage.setItem('totalWordsRead', '300');
                localStorage.setItem('wordCountTotal', '300');
                
                // æ‰‹å‹•ã§ãƒ¡ãƒ¼ãƒ«åˆ¤å®š
                const shouldSend = window.rewardRules ? window.rewardRules.shouldSendMail(300) : 'rewardRulesæœªãƒ­ãƒ¼ãƒ‰';
                
                const info = \`
âœ… 300èªã«è¨­å®šå®Œäº†:
- userProgress: \${JSON.stringify(userProgress)}
- shouldSendMail(300): \${shouldSend}

ğŸ“ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:
1. èª­æ›¸ã‚’å®Œäº†ã—ã¦ãã ã•ã„
2. ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãŒãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã‚‹ã¯ãšã§ã™
                \`;
                
                resultDiv.className = 'result success';
                resultDiv.innerHTML = \`<div class="debug-info">\${info}</div>\`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = \`ã‚¨ãƒ©ãƒ¼: \${error.message}\`;
            }
        }

        function force300Mail() {
            const resultDiv = document.getElementById('test-result');
            try {
                // ç›´æ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
                const queue = JSON.parse(localStorage.getItem('messageQueue') || '[]');
                queue.push({
                    type: 'mail',
                    trigger: 300,
                    timestamp: Date.now()
                });
                localStorage.setItem('messageQueue', JSON.stringify(queue));
                
                resultDiv.className = 'result success';
                resultDiv.textContent = 'âœ… 300èªãƒ¡ãƒ¼ãƒ«ã‚’å¼·åˆ¶çš„ã«ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã—ã¾ã—ãŸã€‚/letterãƒšãƒ¼ã‚¸ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = \`ã‚¨ãƒ©ãƒ¼: \${error.message}\`;
            }
        }

        function testWordCount() {
            const resultDiv = document.getElementById('manual-result');
            const wordCount = parseInt(document.getElementById('word-input').value);
            
            if (isNaN(wordCount)) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'æœ‰åŠ¹ãªæ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                return;
            }
            
            try {
                // æŒ‡å®šèªæ•°ã«è¨­å®š
                const userProgress = { totalWords: wordCount, totalStamps: Math.ceil(wordCount / 100) };
                localStorage.setItem('userProgress', JSON.stringify(userProgress));
                localStorage.setItem('totalWordsRead', wordCount.toString());
                localStorage.setItem('wordCountTotal', wordCount.toString());
                
                // ãƒ¡ãƒ¼ãƒ«ãƒ»æ‰‹ç´™åˆ¤å®š
                const shouldMail = window.rewardRules ? window.rewardRules.shouldSendMail(wordCount) : 'rewardRulesæœªãƒ­ãƒ¼ãƒ‰';
                const shouldLetter = window.rewardRules ? window.rewardRules.shouldSendLetter(wordCount) : 'rewardRulesæœªãƒ­ãƒ¼ãƒ‰';
                
                const info = \`
âœ… \${wordCount}èªã«è¨­å®šå®Œäº†:
- shouldSendMail(\${wordCount}): \${shouldMail}
- shouldSendLetter(\${wordCount}): \${shouldLetter}
                \`;
                
                resultDiv.className = 'result success';
                resultDiv.innerHTML = \`<div class="debug-info">\${info}</div>\`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = \`ã‚¨ãƒ©ãƒ¼: \${error.message}\`;
            }
        }

        function resetAll() {
            const resultDiv = document.getElementById('reset-result');
            try {
                const keys = ['userProgress', 'totalWordsRead', 'wordCountTotal', 'messageQueue'];
                keys.forEach(key => localStorage.removeItem(key));
                
                resultDiv.className = 'result success';
                resultDiv.textContent = 'âœ… å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ';
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = \`ã‚¨ãƒ©ãƒ¼: \${error.message}\`;
            }
        }

        // åˆæœŸçŠ¶æ…‹ç¢ºèª
        window.onload = function() {
            checkCurrentStatus();
            checkMessageQueue();
        };
    </script>
</body>
</html>
EOF < /dev/null
