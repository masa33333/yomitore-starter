<\!DOCTYPE html>
<html>
<head>
    <title>メールシステムデバッグ</title>
    <style>
        body { font-family: 'Arial', sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .debug-info { background: #f8f9fa; font-family: monospace; padding: 10px; border-radius: 3px; white-space: pre-wrap; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .result { margin-top: 10px; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h1>📬 メールシステムデバッグツール</h1>
        
        <div class="section">
            <h2>📊 現在の状態</h2>
            <button onclick="checkCurrentStatus()">状態確認</button>
            <div id="status-result" class="result"></div>
        </div>

        <div class="section">
            <h2>📮 メッセージキュー</h2>
            <button onclick="checkMessageQueue()">キュー確認</button>
            <button onclick="clearMessageQueue()">キュークリア</button>
            <div id="queue-result" class="result"></div>
        </div>

        <div class="section">
            <h2>🧪 300語テスト</h2>
            <button onclick="test300Words()">300語シミュレート</button>
            <button onclick="force300Mail()">300語メール強制送信</button>
            <div id="test-result" class="result"></div>
        </div>

        <div class="section">
            <h2>🔧 メール手動テスト</h2>
            <input type="number" id="word-input" placeholder="語数を入力" value="300" style="padding: 8px; margin: 5px;">
            <button onclick="testWordCount()">指定語数でテスト</button>
            <div id="manual-result" class="result"></div>
        </div>

        <div class="section">
            <h2>🗑️ データリセット</h2>
            <button onclick="resetAll()" style="background: #dc3545;">全データリセット</button>
            <div id="reset-result" class="result"></div>
        </div>
    </div>

    <script>
        function checkCurrentStatus() {
            const resultDiv = document.getElementById('status-result');
            try {
                // LocalStorage data
                const userProgress = JSON.parse(localStorage.getItem('userProgress') || '{}');
                const totalWordsRead = localStorage.getItem('totalWordsRead') || '0';
                const wordCountTotal = localStorage.getItem('wordCountTotal') || '0';
                
                const info = \`
📊 現在の語数データ:
- userProgress.totalWords: \${userProgress.totalWords || 'なし'}
- totalWordsRead: \${totalWordsRead}
- wordCountTotal: \${wordCountTotal}

📝 その他のデータ:
- catName: \${localStorage.getItem('catName') || 'なし'}
- vocabLevel: \${localStorage.getItem('vocabLevel') || 'なし'}
                \`;
                
                resultDiv.className = 'result success';
                resultDiv.innerHTML = \`<div class="debug-info">\${info}</div>\`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = \`エラー: \${error.message}\`;
            }
        }

        function checkMessageQueue() {
            const resultDiv = document.getElementById('queue-result');
            try {
                const queue = JSON.parse(localStorage.getItem('messageQueue') || '[]');
                const info = \`
📬 メッセージキュー:
- キュー内メッセージ数: \${queue.length}
- 内容: \${JSON.stringify(queue, null, 2)}
                \`;
                
                resultDiv.className = queue.length > 0 ? 'result success' : 'result warning';
                resultDiv.innerHTML = \`<div class="debug-info">\${info}</div>\`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = \`エラー: \${error.message}\`;
            }
        }

        function clearMessageQueue() {
            const resultDiv = document.getElementById('queue-result');
            localStorage.removeItem('messageQueue');
            resultDiv.className = 'result success';
            resultDiv.textContent = '✅ メッセージキューをクリアしました';
        }

        function test300Words() {
            const resultDiv = document.getElementById('test-result');
            try {
                // 300語をuserProgressに設定
                const userProgress = { totalWords: 300, totalStamps: 1 };
                localStorage.setItem('userProgress', JSON.stringify(userProgress));
                localStorage.setItem('totalWordsRead', '300');
                localStorage.setItem('wordCountTotal', '300');
                
                // 手動でメール判定
                const shouldSend = window.rewardRules ? window.rewardRules.shouldSendMail(300) : 'rewardRules未ロード';
                
                const info = \`
✅ 300語に設定完了:
- userProgress: \${JSON.stringify(userProgress)}
- shouldSendMail(300): \${shouldSend}

📝 次のステップ:
1. 読書を完了してください
2. メール送信がトリガーされるはずです
                \`;
                
                resultDiv.className = 'result success';
                resultDiv.innerHTML = \`<div class="debug-info">\${info}</div>\`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = \`エラー: \${error.message}\`;
            }
        }

        function force300Mail() {
            const resultDiv = document.getElementById('test-result');
            try {
                // 直接メッセージキューに追加
                const queue = JSON.parse(localStorage.getItem('messageQueue') || '[]');
                queue.push({
                    type: 'mail',
                    trigger: 300,
                    timestamp: Date.now()
                });
                localStorage.setItem('messageQueue', JSON.stringify(queue));
                
                resultDiv.className = 'result success';
                resultDiv.textContent = '✅ 300語メールを強制的にキューに追加しました。/letterページで確認してください。';
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = \`エラー: \${error.message}\`;
            }
        }

        function testWordCount() {
            const resultDiv = document.getElementById('manual-result');
            const wordCount = parseInt(document.getElementById('word-input').value);
            
            if (isNaN(wordCount)) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '有効な数値を入力してください';
                return;
            }
            
            try {
                // 指定語数に設定
                const userProgress = { totalWords: wordCount, totalStamps: Math.ceil(wordCount / 100) };
                localStorage.setItem('userProgress', JSON.stringify(userProgress));
                localStorage.setItem('totalWordsRead', wordCount.toString());
                localStorage.setItem('wordCountTotal', wordCount.toString());
                
                // メール・手紙判定
                const shouldMail = window.rewardRules ? window.rewardRules.shouldSendMail(wordCount) : 'rewardRules未ロード';
                const shouldLetter = window.rewardRules ? window.rewardRules.shouldSendLetter(wordCount) : 'rewardRules未ロード';
                
                const info = \`
✅ \${wordCount}語に設定完了:
- shouldSendMail(\${wordCount}): \${shouldMail}
- shouldSendLetter(\${wordCount}): \${shouldLetter}
                \`;
                
                resultDiv.className = 'result success';
                resultDiv.innerHTML = \`<div class="debug-info">\${info}</div>\`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = \`エラー: \${error.message}\`;
            }
        }

        function resetAll() {
            const resultDiv = document.getElementById('reset-result');
            try {
                const keys = ['userProgress', 'totalWordsRead', 'wordCountTotal', 'messageQueue'];
                keys.forEach(key => localStorage.removeItem(key));
                
                resultDiv.className = 'result success';
                resultDiv.textContent = '✅ 全データをリセットしました';
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = \`エラー: \${error.message}\`;
            }
        }

        // 初期状態確認
        window.onload = function() {
            checkCurrentStatus();
            checkMessageQueue();
        };
    </script>
</body>
</html>
EOF < /dev/null
