<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookmark Double-Tap Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            line-height: 1.6;
        }
        .clickable-word {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }
        .clickable-word:hover {
            background-color: #fef3c7;
        }
        .highlighted {
            background-color: #fde047 !important;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 400px;
            text-align: center;
        }
        .modal button {
            margin: 10px;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .modal .confirm {
            background-color: #dc2626;
            color: white;
        }
        .modal .cancel {
            background-color: #6b7280;
            color: white;
        }
        #log {
            background-color: #f3f4f6;
            padding: 10px;
            border-radius: 4px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Bookmark Double-Tap Test</h1>
    <p>ã“ã®ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ã§ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã§ãã¾ã™ã€‚å˜èªã‚’ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã—ã¦ã—ãŠã‚Šä½œæˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„ã€‚</p>
    
    <div id="content">
        <p>
            <span class="clickable-word" data-word="The" data-idx="0">The</span>
            <span> </span>
            <span class="clickable-word" data-word="quick" data-idx="1">quick</span>
            <span> </span>
            <span class="clickable-word" data-word="brown" data-idx="2">brown</span>
            <span> </span>
            <span class="clickable-word" data-word="fox" data-idx="3">fox</span>
            <span> </span>
            <span class="clickable-word" data-word="jumps" data-idx="4">jumps</span>
            <span> </span>
            <span class="clickable-word" data-word="over" data-idx="5">over</span>
            <span> </span>
            <span class="clickable-word" data-word="the" data-idx="6">the</span>
            <span> </span>
            <span class="clickable-word" data-word="lazy" data-idx="7">lazy</span>
            <span> </span>
            <span class="clickable-word" data-word="dog" data-idx="8">dog</span>
            <span>. </span>
            <span class="clickable-word" data-word="This" data-idx="9">This</span>
            <span> </span>
            <span class="clickable-word" data-word="is" data-idx="10">is</span>
            <span> </span>
            <span class="clickable-word" data-word="a" data-idx="11">a</span>
            <span> </span>
            <span class="clickable-word" data-word="test" data-idx="12">test</span>
            <span> </span>
            <span class="clickable-word" data-word="sentence" data-idx="13">sentence</span>
            <span>.</span>
        </p>
    </div>

    <div id="modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>ã—ãŠã‚Šä½œæˆ</h2>
            <p id="modal-text"></p>
            <button class="cancel" onclick="closeModal()">ã„ã„ãˆ</button>
            <button class="confirm" onclick="confirmBookmark()">ã¯ã„</button>
        </div>
    </div>

    <div id="log"></div>

    <script>
        let lastTapTime = 0;
        let lastTapTarget = null;
        let touchStartTime = 0;
        let touchStartPosition = { x: 0, y: 0 };
        let currentWord = '';
        let currentTokenIndex = 0;

        function log(message) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function showModal(word, tokenIndex) {
            currentWord = word;
            currentTokenIndex = tokenIndex;
            document.getElementById('modal-text').textContent = 
                `ã€Œ${word}ã€ã®ä½ç½®ã§ã—ãŠã‚Šã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã“ã§ä¸€æ™‚ä¸­æ–­ã—ã¾ã™ã‹ï¼Ÿ`;
            document.getElementById('modal').style.display = 'flex';
            log(`ğŸ“– ã—ãŠã‚Šãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º: ${word} (index: ${tokenIndex})`);
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            log(`âŒ ã—ãŠã‚Šä½œæˆã‚­ãƒ£ãƒ³ã‚»ãƒ«`);
        }

        function confirmBookmark() {
            document.getElementById('modal').style.display = 'none';
            log(`âœ… ã—ãŠã‚Šä½œæˆç¢ºå®š: ${currentWord} (index: ${currentTokenIndex})`);
            alert(`ã—ãŠã‚ŠãŒä½œæˆã•ã‚Œã¾ã—ãŸ: ${currentWord}`);
        }

        function handleWordClick(word) {
            log(`ğŸ“š ã‚·ãƒ³ã‚°ãƒ«ã‚¿ãƒƒãƒ—å‡¦ç†: ${word}`);
            // Simulate highlighting
            const elements = document.querySelectorAll(`[data-word="${word}"]`);
            elements.forEach(el => {
                el.classList.add('highlighted');
                setTimeout(() => {
                    el.classList.remove('highlighted');
                }, 1000);
            });
        }

        function handleDoubleTap(target) {
            const word = target.dataset.word;
            const tokenIndex = parseInt(target.dataset.idx);
            log(`ğŸ¯ ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—å‡¦ç†å®Ÿè¡Œ: ${word} (index: ${tokenIndex})`);
            showModal(word, tokenIndex);
        }

        // Touch event handlers
        document.addEventListener('touchstart', function(e) {
            if (e.target.classList.contains('clickable-word')) {
                const touch = e.touches[0];
                touchStartTime = Date.now();
                touchStartPosition = { x: touch.clientX, y: touch.clientY };
                log(`ğŸ‘† ã‚¿ãƒƒãƒé–‹å§‹: ${e.target.dataset.word}`);
            }
        });

        document.addEventListener('touchend', function(e) {
            const target = e.target;
            if (!target.classList.contains('clickable-word')) return;

            const touchEndTime = Date.now();
            const touchDuration = touchEndTime - touchStartTime;
            
            const touch = e.changedTouches[0];
            const touchEndPosition = { x: touch.clientX, y: touch.clientY };
            const moveDistance = Math.sqrt(
                Math.pow(touchEndPosition.x - touchStartPosition.x, 2) + 
                Math.pow(touchEndPosition.y - touchStartPosition.y, 2)
            );

            log(`ğŸ“± ã‚¿ãƒƒãƒçµ‚äº†: ${target.dataset.word} (æ™‚é–“=${touchDuration}ms, ç§»å‹•=${moveDistance.toFixed(1)}px)`);

            // ã‚¿ãƒƒãƒæ™‚é–“ãŒçŸ­ã™ãã‚‹ã‹ç§»å‹•è·é›¢ãŒå¤§ãã„å ´åˆã¯ç„¡è¦–
            if (touchDuration < 100 || moveDistance > 10) {
                log(`â­ï¸ ã‚¿ãƒƒãƒç„¡è¦–: æ¡ä»¶æœªæº€`);
                return;
            }

            const word = target.dataset.word;
            const timeSinceLastTap = touchEndTime - lastTapTime;
            const isSameTarget = lastTapTarget === target;
            const isDoubleTap = timeSinceLastTap < 300 && isSameTarget;

            log(`ğŸ” ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—åˆ¤å®š: æ™‚é–“å·®=${timeSinceLastTap}ms, åŒã˜è¦ç´ =${isSameTarget}, ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—=${isDoubleTap}`);

            if (isDoubleTap) {
                log(`âœ… ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—æ¤œçŸ¥: ${word}`);
                // ã‚·ãƒ³ã‚°ãƒ«ã‚¿ãƒƒãƒ—ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚¯ãƒªã‚¢
                if (target._singleTapTimeout) {
                    clearTimeout(target._singleTapTimeout);
                    target._singleTapTimeout = null;
                    log(`ğŸš« ã‚·ãƒ³ã‚°ãƒ«ã‚¿ãƒƒãƒ—ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¯ãƒªã‚¢`);
                }
                handleDoubleTap(target);
                lastTapTime = 0;
                lastTapTarget = null;
                return;
            }

            // ã‚·ãƒ³ã‚°ãƒ«ã‚¿ãƒƒãƒ—ã®å ´åˆã€300mså¾Œã«å‡¦ç†
            lastTapTime = touchEndTime;
            lastTapTarget = target;

            if (target._singleTapTimeout) {
                clearTimeout(target._singleTapTimeout);
            }

            target._singleTapTimeout = setTimeout(() => {
                log(`â° ã‚·ãƒ³ã‚°ãƒ«ã‚¿ãƒƒãƒ—ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå®Ÿè¡Œ: ${word}`);
                handleWordClick(word);
                lastTapTime = 0;
                lastTapTarget = null;
            }, 300);

            log(`â±ï¸ ã‚·ãƒ³ã‚°ãƒ«ã‚¿ãƒƒãƒ—ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š: 300ms`);
        });

        // Mouse events for desktop testing
        document.addEventListener('click', function(e) {
            if (!e.target.classList.contains('clickable-word')) return;
            if (e.target._touchHandled) return; // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã§å‡¦ç†æ¸ˆã¿

            const target = e.target;
            const currentTime = Date.now();
            const timeSinceLastClick = currentTime - lastTapTime;
            const isSameTarget = lastTapTarget === target;
            const isDoubleClick = timeSinceLastClick < 300 && isSameTarget;

            log(`ğŸ–±ï¸ ãƒã‚¦ã‚¹ã‚¯ãƒªãƒƒã‚¯: ${target.dataset.word} (æ™‚é–“å·®=${timeSinceLastClick}ms, ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯=${isDoubleClick})`);

            if (isDoubleClick) {
                log(`âœ… ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯æ¤œçŸ¥: ${target.dataset.word}`);
                handleDoubleTap(target);
                lastTapTime = 0;
                lastTapTarget = null;
                return;
            }

            lastTapTime = currentTime;
            lastTapTarget = target;

            setTimeout(() => {
                if (lastTapTime === currentTime && lastTapTarget === target) {
                    handleWordClick(target.dataset.word);
                    lastTapTime = 0;
                    lastTapTarget = null;
                }
            }, 300);
        });

        log('ğŸ“ ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸åˆæœŸåŒ–å®Œäº†');
        log('ğŸ’¡ ä½¿ç”¨æ–¹æ³•: å˜èªã‚’ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—/ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã—ãŠã‚Šä½œæˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º');
    </script>
</body>
</html>