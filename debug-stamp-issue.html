<!DOCTYPE html>
<html>
<head>
    <title>ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰å•é¡Œè¨ºæ–­ãƒ„ãƒ¼ãƒ«</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .problem { background: #ffebee; border-color: #f44336; }
        .normal { background: #e8f5e8; border-color: #4caf50; }
        .debug { background: #f0f0f0; border-color: #666; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
        button { padding: 10px 20px; margin: 5px; }
    </style>
</head>
<body>
    <h1>ğŸ› ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰å•é¡Œè¨ºæ–­ãƒ„ãƒ¼ãƒ«</h1>
    
    <div class="section problem">
        <h2>ğŸ“‹ å•é¡Œã®æ¦‚è¦</h2>
        <p><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼å ±å‘Šï¼š</strong> ç´¯è¨ˆ158èªãªã®ã«ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰ãŒ16å€‹åŸ‹ã¾ã£ã¦ã„ã‚‹</p>
        <p><strong>æœŸå¾…å€¤ï¼š</strong> 158èª Ã· 100 = 1å€‹ï¼ˆã‚‚ã—ãã¯2å€‹ï¼‰ã®ã‚¹ã‚¿ãƒ³ãƒ—</p>
        <p><strong>å®Ÿéš›ï¼š</strong> 16å€‹ã®ã‚¹ã‚¿ãƒ³ãƒ—ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹</p>
    </div>

    <div class="section debug">
        <h2>ğŸ” è¨ºæ–­çµæœ</h2>
        <div id="diagnosis">è¨ºæ–­ä¸­...</div>
    </div>

    <div class="section">
        <h2>ğŸ› ï¸ æ‰‹å‹•è¨ºæ–­</h2>
        <button onclick="runDiagnosis()">è¨ºæ–­é–‹å§‹</button>
        <button onclick="showRawData()">ç”Ÿãƒ‡ãƒ¼ã‚¿è¡¨ç¤º</button>
        <button onclick="fixIssue()">å•é¡Œä¿®æ­£</button>
        <button onclick="clearData()">ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢</button>
    </div>

    <div class="section">
        <h2>ğŸ“Š ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º</h2>
        <div id="dataDisplay"></div>
    </div>

    <script>
        function runDiagnosis() {
            const diagnosis = document.getElementById('diagnosis');
            const dataDisplay = document.getElementById('dataDisplay');
            
            // localStorage ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const totalWordsRead = localStorage.getItem('totalWordsRead') || '0';
            const userProgressRaw = localStorage.getItem('userProgress');
            const stampCardRaw = localStorage.getItem('stampCard');
            
            let userProgress = {};
            let stampCard = [];
            
            try {
                userProgress = JSON.parse(userProgressRaw || '{}');
            } catch (e) {
                userProgress = { error: e.message };
            }
            
            try {
                stampCard = JSON.parse(stampCardRaw || '[]');
            } catch (e) {
                stampCard = { error: e.message };
            }
            
            // è¨ºæ–­ãƒ­ã‚¸ãƒƒã‚¯
            const totalWords = parseInt(totalWordsRead, 10);
            const expectedStamps = Math.floor(totalWords / 100);
            const actualStamps = userProgress.currentCardStamps || 0;
            const totalStamps = userProgress.totalStamps || 0;
            
            let diagnosisText = '';
            
            diagnosisText += `<h3>ğŸ” è¨ºæ–­çµæœ</h3>`;
            diagnosisText += `<p><strong>ç´¯è¨ˆèªæ•° (totalWordsRead):</strong> ${totalWords}èª</p>`;
            diagnosisText += `<p><strong>æœŸå¾…ã‚¹ã‚¿ãƒ³ãƒ—æ•°:</strong> ${expectedStamps}å€‹ (${totalWords} Ã· 100)</p>`;
            diagnosisText += `<p><strong>å®Ÿéš›ã®ç¾åœ¨ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ãƒ³ãƒ—æ•°:</strong> ${actualStamps}å€‹</p>`;
            diagnosisText += `<p><strong>å®Ÿéš›ã®ç´¯è¨ˆã‚¹ã‚¿ãƒ³ãƒ—æ•°:</strong> ${totalStamps}å€‹</p>`;
            
            if (actualStamps > expectedStamps) {
                diagnosisText += `<p class="problem">âŒ å•é¡Œç™ºè¦‹ï¼šã‚¹ã‚¿ãƒ³ãƒ—æ•°ãŒæœŸå¾…å€¤ã‚ˆã‚Šå¤šã„</p>`;
                diagnosisText += `<p><strong>åŸå› æ¨æ¸¬ï¼š</strong></p>`;
                diagnosisText += `<ul>`;
                diagnosisText += `<li>æ—§ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰æ–°ã‚·ã‚¹ãƒ†ãƒ ã¸ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ™‚ã®å•é¡Œ</li>`;
                diagnosisText += `<li>completedReadings ã®å€¤ãŒ totalStamps ã¨ã—ã¦ä½¿ç”¨ã•ã‚ŒãŸå¯èƒ½æ€§</li>`;
                diagnosisText += `<li>ã‚¹ã‚¿ãƒ³ãƒ—è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã®å•é¡Œ</li>`;
                diagnosisText += `</ul>`;
            } else {
                diagnosisText += `<p class="normal">âœ… ã‚¹ã‚¿ãƒ³ãƒ—æ•°ã¯æ­£å¸¸</p>`;
            }
            
            diagnosis.innerHTML = diagnosisText;
            
            // è©³ç´°ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
            dataDisplay.innerHTML = `
                <h3>ğŸ“‹ è©³ç´°ãƒ‡ãƒ¼ã‚¿</h3>
                <h4>totalWordsRead (localStorage)</h4>
                <pre>${totalWordsRead}</pre>
                
                <h4>userProgress (localStorage)</h4>
                <pre>${JSON.stringify(userProgress, null, 2)}</pre>
                
                <h4>stampCard (localStorage)</h4>
                <pre>${JSON.stringify(stampCard, null, 2)}</pre>
            `;
        }
        
        function showRawData() {
            const dataDisplay = document.getElementById('dataDisplay');
            dataDisplay.innerHTML = `
                <h3>ğŸ” ç”Ÿãƒ‡ãƒ¼ã‚¿</h3>
                <h4>totalWordsRead</h4>
                <pre>${localStorage.getItem('totalWordsRead') || 'null'}</pre>
                
                <h4>userProgress</h4>
                <pre>${localStorage.getItem('userProgress') || 'null'}</pre>
                
                <h4>stampCard</h4>
                <pre>${localStorage.getItem('stampCard') || 'null'}</pre>
                
                <h4>completedReadings</h4>
                <pre>${localStorage.getItem('completedReadings') || 'null'}</pre>
            `;
        }
        
        function fixIssue() {
            const totalWords = parseInt(localStorage.getItem('totalWordsRead') || '0', 10);
            const expectedStamps = Math.floor(totalWords / 100);
            const expectedCurrentCardStamps = expectedStamps % 20;
            const expectedCompletedCards = Math.floor(expectedStamps / 20);
            
            const fixedProgress = {
                totalStamps: expectedStamps,
                totalWords: totalWords,
                currentCardStamps: expectedCurrentCardStamps,
                completedCards: expectedCompletedCards,
                bronzeCoins: Math.floor(expectedStamps / 10),
                bronzeTrophies: Math.floor(expectedCompletedCards / 5),
                silverTrophies: Math.floor(Math.floor(expectedCompletedCards / 5) / 5),
                goldTrophies: Math.floor(Math.floor(Math.floor(expectedCompletedCards / 5) / 5) / 5),
                platinumTrophies: Math.floor(Math.floor(Math.floor(Math.floor(expectedCompletedCards / 5) / 5) / 5) / 4),
                consecutiveLoginDays: 0,
                lastLoginDate: '',
                dailyStoriesRead: 0,
                dailyFirstStoryBonus: false,
                dailyGoalAchieved: false,
                lastUpdated: new Date().toISOString()
            };
            
            localStorage.setItem('userProgress', JSON.stringify(fixedProgress));
            
            // ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚‚ä¿®æ­£
            const stampCardData = [];
            for (let i = 0; i < expectedStamps; i++) {
                stampCardData.push({
                    id: `stamp_${Date.now()}_${i}`,
                    completionDate: new Date().toISOString(),
                    wordCount: 100,
                    level: 1,
                    sessionDuration: 60000,
                    wpm: 120,
                    title: 'ä¿®æ­£ã•ã‚ŒãŸã‚¹ã‚¿ãƒ³ãƒ—',
                    contentType: 'reading'
                });
            }
            localStorage.setItem('stampCard', JSON.stringify(stampCardData));
            
            alert('å•é¡Œã‚’ä¿®æ­£ã—ã¾ã—ãŸï¼ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
            location.reload();
        }
        
        function clearData() {
            if (confirm('ã™ã¹ã¦ã®ã‚¹ã‚¿ãƒ³ãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem('userProgress');
                localStorage.removeItem('stampCard');
                localStorage.removeItem('totalWordsRead');
                localStorage.removeItem('completedReadings');
                alert('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸï¼');
                location.reload();
            }
        }
        
        // è‡ªå‹•è¨ºæ–­
        window.onload = function() {
            runDiagnosis();
        };
    </script>
</body>
</html>