<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ã‚¿ãƒ³ãƒ—å•é¡Œä¿®æ­£ãƒ„ãƒ¼ãƒ«</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .container { max-width: 800px; margin: 0 auto; }
        .status { padding: 10px; border-radius: 5px; margin: 10px 0; }
        .error { background-color: #ffe6e6; border-left: 4px solid #ff0000; }
        .success { background-color: #e6ffe6; border-left: 4px solid #00ff00; }
        .warning { background-color: #fff3cd; border-left: 4px solid #ffc107; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .data { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; font-family: monospace; }
        pre { background: #f1f3f4; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ ã‚¹ã‚¿ãƒ³ãƒ—è¨ˆç®—å•é¡Œ è¨ºæ–­ãƒ»ä¿®æ­£ãƒ„ãƒ¼ãƒ«</h1>
        
        <div class="status warning">
            <strong>å•é¡Œ</strong>: ç´¯è¨ˆ158èªãªã®ã«ã‚¹ã‚¿ãƒ³ãƒ—ãŒ16å€‹è¡¨ç¤ºã•ã‚Œã‚‹
        </div>
        
        <button onclick="diagnose()">è¨ºæ–­é–‹å§‹</button>
        <button onclick="fixStampIssue()">å•é¡Œä¿®æ­£</button>
        <button onclick="clearAllData()" style="background: #dc3545;">å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢</button>
        
        <div id="results"></div>
    </div>

    <script>
        function diagnose() {
            const results = document.getElementById('results');
            
            // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const totalWordsRead = parseInt(localStorage.getItem('totalWordsRead') || '0');
            const userProgress = JSON.parse(localStorage.getItem('userProgress') || '{}');
            const stampCard = JSON.parse(localStorage.getItem('stampCard') || '{}');
            const completedReadings = parseInt(localStorage.getItem('completedReadings') || '0');
            const dailyData = JSON.parse(localStorage.getItem('dailyData') || '{}');
            
            // æ­£ã—ã„ã‚¹ã‚¿ãƒ³ãƒ—æ•°ã‚’è¨ˆç®—
            const correctStamps = Math.floor(totalWordsRead / 100);
            
            let html = '<h2>ğŸ“Š è¨ºæ–­çµæœ</h2>';
            
            html += '<div class="data">';
            html += '<h3>ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿çŠ¶æ³:</h3>';
            html += `<strong>ç´¯è¨ˆèªæ•°</strong>: ${totalWordsRead} èª<br>`;
            html += `<strong>æ­£ã—ã„ã‚¹ã‚¿ãƒ³ãƒ—æ•°</strong>: ${correctStamps} å€‹<br>`;
            html += `<strong>completedReadings</strong>: ${completedReadings} å›<br>`;
            html += '</div>';
            
            if (userProgress.totalStamps) {
                html += `<div class="error">`;
                html += `<strong>âŒ å•é¡Œç™ºè¦‹!</strong><br>`;
                html += `userProgress.totalStamps: ${userProgress.totalStamps} å€‹ (æ­£ã—ãã¯ ${correctStamps} å€‹)<br>`;
                html += `<strong>å·®åˆ†</strong>: ${userProgress.totalStamps - correctStamps} å€‹å¤šã„`;
                html += `</div>`;
            }
            
            if (stampCard.stamps) {
                const filledStamps = stampCard.stamps.filter(s => s.earned).length;
                html += `<div class="error">`;
                html += `<strong>âŒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰å•é¡Œ!</strong><br>`;
                html += `åŸ‹ã¾ã£ã¦ã„ã‚‹ã‚¹ã‚¿ãƒ³ãƒ—: ${filledStamps} å€‹ (æ­£ã—ãã¯ ${correctStamps} å€‹)<br>`;
                html += `</div>`;
            }
            
            html += '<div class="data">';
            html += '<h3>å…¨LocalStorageãƒ‡ãƒ¼ã‚¿:</h3>';
            html += '<pre>';
            html += `totalWordsRead: ${totalWordsRead}\n`;
            html += `completedReadings: ${completedReadings}\n`;
            html += `userProgress: ${JSON.stringify(userProgress, null, 2)}\n`;
            html += `stampCard: ${JSON.stringify(stampCard, null, 2)}\n`;
            html += `dailyData: ${JSON.stringify(dailyData, null, 2)}`;
            html += '</pre>';
            html += '</div>';
            
            results.innerHTML = html;
        }
        
        function fixStampIssue() {
            const totalWordsRead = parseInt(localStorage.getItem('totalWordsRead') || '0');
            const correctStamps = Math.floor(totalWordsRead / 100);
            
            // userProgressã‚’ä¿®æ­£
            const userProgress = JSON.parse(localStorage.getItem('userProgress') || '{}');
            userProgress.totalStamps = correctStamps;
            userProgress.totalWords = totalWordsRead;
            localStorage.setItem('userProgress', JSON.stringify(userProgress));
            
            // stampCardã‚’ä¿®æ­£
            const stampCard = {
                stamps: [],
                completedCards: Math.floor(correctStamps / 20),
                currentCardStartStamp: Math.floor(correctStamps / 20) * 20,
                lastUpdated: Date.now()
            };
            
            // æ­£ã—ã„æ•°ã®ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ç”Ÿæˆ
            for (let i = 0; i < 20; i++) {
                const stampNumber = stampCard.currentCardStartStamp + i;
                stampCard.stamps.push({
                    id: i,
                    earned: stampNumber < correctStamps,
                    earnedAt: stampNumber < correctStamps ? Date.now() - (correctStamps - stampNumber) * 86400000 : null
                });
            }
            
            localStorage.setItem('stampCard', JSON.stringify(stampCard));
            
            const results = document.getElementById('results');
            results.innerHTML = `
                <div class="success">
                    <h2>âœ… ä¿®æ­£å®Œäº†!</h2>
                    <strong>ç´¯è¨ˆèªæ•°</strong>: ${totalWordsRead} èª<br>
                    <strong>ã‚¹ã‚¿ãƒ³ãƒ—æ•°</strong>: ${correctStamps} å€‹ (ä¿®æ­£å‰: ${userProgress.totalStamps || 'N/A'})<br>
                    <strong>æ¬¡ã®ã‚¹ã‚¿ãƒ³ãƒ—ã¾ã§</strong>: ${100 - (totalWordsRead % 100)} èª<br>
                    <br>
                    èª­ã¿ãƒˆãƒ¬ã‚¢ãƒ—ãƒªã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚
                </div>
            `;
        }
        
        function clearAllData() {
            if (confirm('æœ¬å½“ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                [
                    'totalWordsRead',
                    'completedReadings', 
                    'userProgress',
                    'stampCard',
                    'dailyData',
                    'totalReadingTime',
                    'readingHistory'
                ].forEach(key => localStorage.removeItem(key));
                
                document.getElementById('results').innerHTML = `
                    <div class="success">
                        <h2>ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢å®Œäº†</h2>
                        èª­ã¿ãƒˆãƒ¬ã‚¢ãƒ—ãƒªã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚
                    </div>
                `;
            }
        }
    </script>
</body>
</html>