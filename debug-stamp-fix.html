<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>スタンプ問題修正ツール</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .container { max-width: 800px; margin: 0 auto; }
        .status { padding: 10px; border-radius: 5px; margin: 10px 0; }
        .error { background-color: #ffe6e6; border-left: 4px solid #ff0000; }
        .success { background-color: #e6ffe6; border-left: 4px solid #00ff00; }
        .warning { background-color: #fff3cd; border-left: 4px solid #ffc107; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .data { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; font-family: monospace; }
        pre { background: #f1f3f4; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 スタンプ計算問題 診断・修正ツール</h1>
        
        <div class="status warning">
            <strong>問題</strong>: 累計158語なのにスタンプが16個表示される
        </div>
        
        <button onclick="diagnose()">診断開始</button>
        <button onclick="fixStampIssue()">問題修正</button>
        <button onclick="clearAllData()" style="background: #dc3545;">全データクリア</button>
        
        <div id="results"></div>
    </div>

    <script>
        function diagnose() {
            const results = document.getElementById('results');
            
            // 現在のデータを取得
            const totalWordsRead = parseInt(localStorage.getItem('totalWordsRead') || '0');
            const userProgress = JSON.parse(localStorage.getItem('userProgress') || '{}');
            const stampCard = JSON.parse(localStorage.getItem('stampCard') || '{}');
            const completedReadings = parseInt(localStorage.getItem('completedReadings') || '0');
            const dailyData = JSON.parse(localStorage.getItem('dailyData') || '{}');
            
            // 正しいスタンプ数を計算
            const correctStamps = Math.floor(totalWordsRead / 100);
            
            let html = '<h2>📊 診断結果</h2>';
            
            html += '<div class="data">';
            html += '<h3>現在のデータ状況:</h3>';
            html += `<strong>累計語数</strong>: ${totalWordsRead} 語<br>`;
            html += `<strong>正しいスタンプ数</strong>: ${correctStamps} 個<br>`;
            html += `<strong>completedReadings</strong>: ${completedReadings} 回<br>`;
            html += '</div>';
            
            if (userProgress.totalStamps) {
                html += `<div class="error">`;
                html += `<strong>❌ 問題発見!</strong><br>`;
                html += `userProgress.totalStamps: ${userProgress.totalStamps} 個 (正しくは ${correctStamps} 個)<br>`;
                html += `<strong>差分</strong>: ${userProgress.totalStamps - correctStamps} 個多い`;
                html += `</div>`;
            }
            
            if (stampCard.stamps) {
                const filledStamps = stampCard.stamps.filter(s => s.earned).length;
                html += `<div class="error">`;
                html += `<strong>❌ スタンプカード問題!</strong><br>`;
                html += `埋まっているスタンプ: ${filledStamps} 個 (正しくは ${correctStamps} 個)<br>`;
                html += `</div>`;
            }
            
            html += '<div class="data">';
            html += '<h3>全LocalStorageデータ:</h3>';
            html += '<pre>';
            html += `totalWordsRead: ${totalWordsRead}\n`;
            html += `completedReadings: ${completedReadings}\n`;
            html += `userProgress: ${JSON.stringify(userProgress, null, 2)}\n`;
            html += `stampCard: ${JSON.stringify(stampCard, null, 2)}\n`;
            html += `dailyData: ${JSON.stringify(dailyData, null, 2)}`;
            html += '</pre>';
            html += '</div>';
            
            results.innerHTML = html;
        }
        
        function fixStampIssue() {
            const totalWordsRead = parseInt(localStorage.getItem('totalWordsRead') || '0');
            const correctStamps = Math.floor(totalWordsRead / 100);
            
            // userProgressを修正
            const userProgress = JSON.parse(localStorage.getItem('userProgress') || '{}');
            userProgress.totalStamps = correctStamps;
            userProgress.totalWords = totalWordsRead;
            localStorage.setItem('userProgress', JSON.stringify(userProgress));
            
            // stampCardを修正
            const stampCard = {
                stamps: [],
                completedCards: Math.floor(correctStamps / 20),
                currentCardStartStamp: Math.floor(correctStamps / 20) * 20,
                lastUpdated: Date.now()
            };
            
            // 正しい数のスタンプを生成
            for (let i = 0; i < 20; i++) {
                const stampNumber = stampCard.currentCardStartStamp + i;
                stampCard.stamps.push({
                    id: i,
                    earned: stampNumber < correctStamps,
                    earnedAt: stampNumber < correctStamps ? Date.now() - (correctStamps - stampNumber) * 86400000 : null
                });
            }
            
            localStorage.setItem('stampCard', JSON.stringify(stampCard));
            
            const results = document.getElementById('results');
            results.innerHTML = `
                <div class="success">
                    <h2>✅ 修正完了!</h2>
                    <strong>累計語数</strong>: ${totalWordsRead} 語<br>
                    <strong>スタンプ数</strong>: ${correctStamps} 個 (修正前: ${userProgress.totalStamps || 'N/A'})<br>
                    <strong>次のスタンプまで</strong>: ${100 - (totalWordsRead % 100)} 語<br>
                    <br>
                    読みトレアプリを再読み込みしてください。
                </div>
            `;
        }
        
        function clearAllData() {
            if (confirm('本当に全データを削除しますか？この操作は元に戻せません。')) {
                [
                    'totalWordsRead',
                    'completedReadings', 
                    'userProgress',
                    'stampCard',
                    'dailyData',
                    'totalReadingTime',
                    'readingHistory'
                ].forEach(key => localStorage.removeItem(key));
                
                document.getElementById('results').innerHTML = `
                    <div class="success">
                        <h2>🗑️ 全データクリア完了</h2>
                        読みトレアプリを再読み込みしてください。
                    </div>
                `;
            }
        }
    </script>
</body>
</html>