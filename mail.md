# === ç›®çš„ ===========================================================
# 1. æ—§ãƒ¡ãƒ¼ãƒ«ï¼æ‰‹ç´™é…ä¿¡ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Œå…¨å‰Šé™¤
# 2. æ–°ãƒ«ãƒ¼ãƒ«ï¼š
#    - å‡ºç™ºãƒ¡ãƒ¼ãƒ«ï¼š300èª
#    - ä»¥å¾Œã€ãƒ¡ãƒ¼ãƒ«3é€šï¼ˆ+5,000èªé–“éš”ï¼‰â†’ æ¬¡ã®+5,000èªã§æ‰‹ç´™
#      â”” ä¾‹ï¼š300, 5â€¯300, 10â€¯300 ã§ãƒ¡ãƒ¼ãƒ«ã€20â€¯300 ã§æ‰‹ç´™
#      â”” ä»¥é™ 20â€¯000èªå‘¨æœŸï¼ˆãƒ¡ãƒ¼ãƒ«Ã—3 â†’ æ‰‹ç´™ï¼‰ã®ç¹°ã‚Šè¿”ã—
#    - 1â€¯000â€¯000èªã§ æ‰‹ç´™50é€š / ãƒ¡ãƒ¼ãƒ«150é€š
# 3. ã‚³ã‚¤ãƒ³ï¼ˆ2â€¯000èªï¼‰ã€ãƒˆãƒ­ãƒ•ã‚£ãƒ¼ï¼ˆå›ºå®šé–¾å€¤ï¼‰ã¨è¡çªã—ãªã„ã‚ˆã†åˆ¤å®šã‚’åˆ†é›¢
# 4. ãƒ¡ãƒ¼ãƒ«ï¼æ‰‹ç´™æœ¬æ–‡ã¯åˆ¥ãƒ•ã‚©ãƒ«ãƒ€ã¸å¤–å‡ºã—
# 5. æˆç”° (tokyo.png)ãƒ»ã‚½ã‚¦ãƒ« (seoul.png)ãƒ»åŒ—äº¬ (beijing.png) ã®æ—¢å­˜ç”»åƒã‚’ä½¿ç”¨
# ===================================================================

# -------------------------------------------------------------------
# âŒ â… . ä¸è¦ã‚³ãƒ¼ãƒ‰ã®å‰Šé™¤
# -------------------------------------------------------------------
# - src/utils/sendInFlightMail.ts
# - src/utils/sendLetter.ts
# - src/data/mails/*
# - src/data/letters/*
# - æ—§ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‘¼ã‚“ã§ã„ã‚‹è¡Œï¼ˆProgressWatcher.tsx, ReadingClient.tsx ãªã©ï¼‰
#   ã€ŒshouldSendMail/Letterã€ç›¸å½“ã®å‡¦ç†ã¯å…¨å‰Šé™¤

# -------------------------------------------------------------------
# âœ… â…¡. æ–°ã—ã„åˆ¤å®šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’è¿½åŠ 
# -------------------------------------------------------------------
# ğŸ“„ src/utils/rewardRules.ts
# -------------------------------------------------
export function shouldSendMail(totalWords: number): boolean {
  // â‘  å‡ºç™ºãƒ¡ãƒ¼ãƒ«ï¼ˆ300èªï¼‰
  if (totalWords === 300) return true;

  // â‘¡ å‘¨æœŸãƒ¡ãƒ¼ãƒ«ï¼š300èªã‚’åŸºæº–ã« 20â€¯000èªã‚µã‚¤ã‚¯ãƒ«
  //     (totalWords - 300) % 20â€¯000 ãŒ  5â€¯000 / 10â€¯000 / 15â€¯000 ã®æ™‚
  const d = totalWords - 300;
  return d > 0 && [5_000, 10_000, 15_000].includes(d % 20_000);
}

export function shouldSendLetter(totalWords: number): boolean {
  // æ‰‹ç´™ï¼š20â€¯300èªã‚’èµ·ç‚¹ã« 20â€¯000èªå‘¨æœŸ
  return totalWords >= 20_300 && (totalWords - 20_300) % 20_000 === 0;
}

// ã‚³ã‚¤ãƒ³ï¼šã‚«ãƒ¼ãƒ‰ 1 æš (2â€¯000èª) æ¯
export function shouldGiveCoin(totalWords: number): boolean {
  return totalWords > 0 && totalWords % 2_000 === 0;
}

// ãƒˆãƒ­ãƒ•ã‚£ãƒ¼ï¼šç´¯ç©é–¾å€¤
export function getTrophyRank(totalWords: number):
  'NONE' | 'MEDAL' | 'BRONZE' | 'SILVER' | 'GOLD' | 'PLATINUM' {
  if (totalWords >= 1_000_000) return 'PLATINUM';
  if (totalWords >=   500_000) return 'GOLD';
  if (totalWords >=   100_000) return 'SILVER';
  if (totalWords >=    20_000) return 'BRONZE';
  if (totalWords >=     2_000) return 'MEDAL';
  return 'NONE';
}
# -------------------------------------------------

# -------------------------------------------------------------------
# âœ… â…¢. ProgressWatcher æ”¹ä¿®ä¾‹
# -------------------------------------------------------------------
# ğŸ“„ src/components/ProgressWatcher.tsx
import {
  shouldSendMail,
  shouldSendLetter,
  shouldGiveCoin,
  getTrophyRank,
} from "@/utils/rewardRules";

if (shouldSendMail(totalWords))   queueEvent("MAIL");
if (shouldSendLetter(totalWords)) queueEvent("LETTER");
if (shouldGiveCoin(totalWords))   queueEvent("COIN");

const trophy = getTrophyRank(totalWords);
if (trophy !== "NONE" && trophy !== lastTrophyShown) queueEvent(trophy);

# â€» queueEvent ã¯æ—¢å­˜ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ãƒˆãƒ¼ã‚¹ãƒˆç”¨ã®ã‚­ãƒ¥ãƒ¼ã‚’ãã®ã¾ã¾æµç”¨
#   å„ªå…ˆé †ä½ï¼šLETTER > TROPHY > MAIL > COIN > STAMP

# -------------------------------------------------------------------
# âœ… â…£. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡ã®ç½®ãå ´æ‰€ã‚’æ–°è¨­
# -------------------------------------------------------------------
# ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆ
# src/
# â””â”€ data/
#    â””â”€ messages/
#       â”œâ”€ mails/     â† Markdown or JSON
#       â””â”€ letters/   â† Markdown or JSON
#
# ä¾‹: src/data/messages/mails/000_tokyo_departure.md
# ---
# id: mail-000
# city: Tokyo
# image: /images/tokyo.png
# ---
# -ã„ã¾æˆç”°ç©ºæ¸¯ã®ã‚²ãƒ¼ãƒˆå‰ã«ã„ã¾ã™ã€‚è·ç‰©ã¯ç„¡äº‹ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³â€¦â€¦
#
# â€»ã‚½ã‚¦ãƒ«, åŒ—äº¬ã®æ‰‹ç´™ã‚‚ letters/ ä»¥ä¸‹ã«åŒæ§˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§é…ç½®

# -------------------------------------------------------------------
# âœ… â…¤. ãƒ­ãƒ¼ãƒ€ãƒ¼ & è¡¨ç¤º
# -------------------------------------------------------------------
# 1. loadMessage(kind: "mail" | "letter", index) ã§
#    dynamic import(`@/data/messages/${kind}s/${slug}.md`)
# 2. frontâ€‘matter.image ã‚’ <Image src={image} ... /> ã«æ¸¡ã™
# 3. Markdown æœ¬æ–‡ã¯ react-markdown ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°

# -------------------------------------------------------------------
# âœ… â…¥. ãƒ†ã‚¹ãƒˆ
# -------------------------------------------------------------------
# - 300èª â†’ MAIL (tokyo)
# - 5â€¯300èª â†’ MAIL
# - 10â€¯300èª â†’ MAIL
# - 20â€¯300èª â†’ LETTER (seoul) + BRONZE (åŒèªæ•°åˆ°é”)
# - 25â€¯300 / 30â€¯300 / 35â€¯300 â†’ MAIL
# - 40â€¯300 â†’ LETTER (beijing)
# - 1â€¯000â€¯000èª â†’ LETTER #50 + PLATINUM
# jest / vitest ã§èªæ•°ã‚’ãƒ¢ãƒƒã‚¯ã—ã¦ä¸Šè¨˜ã‚·ãƒŠãƒªã‚ªã‚’ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆç¢ºèª

# -------------------------------------------------------------------
# ğŸš€ å®Œäº†
# ã“ã‚Œã§ã€Œãƒ¡ãƒ¼ãƒ«3é€šâ†’æ‰‹ç´™1é€šã€ã®ãƒšãƒ¼ã‚¹ãŒç¢ºå®Ÿã«å®Ÿç¾ã—ã€
# ã‚³ã‚¤ãƒ³ï¼ãƒˆãƒ­ãƒ•ã‚£ãƒ¼ã¨ã‚‚è¡çªã—ã¾ã›ã‚“ã€‚
ğŸ”‘ ã“ã‚Œã§ã§ãã‚‹ã“ã¨
èªæ•° 300 ã§ã€Œæˆç”°å‡ºç™ºãƒ¡ãƒ¼ãƒ«ã€ã‚’å¿…ãšé€ä¿¡

ãã®å¾Œã¯ ãƒ¡ãƒ¼ãƒ«Ã—3 â†’ æ‰‹ç´™ ã® 20â€¯000èªã‚µã‚¤ã‚¯ãƒ«ãŒè‡ªå‹•é€²è¡Œ

ã‚³ã‚¤ãƒ³ï¼ˆ2â€¯000èªãŠãï¼‰ãƒ»å„ç¨®ãƒˆãƒ­ãƒ•ã‚£ãƒ¼ã‚‚æ—¢å­˜ã‚­ãƒ¥ãƒ¼ã§è¡¨ç¤ºé †ã‚’è‡ªå‹•èª¿æ•´

ãƒ¡ãƒ¼ãƒ«ï¼æ‰‹ç´™æœ¬æ–‡ã¯ src/data/messages/ ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ãƒ»å·®æ›¿ãˆã™ã‚‹ã ã‘ã§æ›´æ–°å¯èƒ½


Q1. é€²æ—ãƒˆãƒªã‚¬ãƒ¼ã¯å‹•ä½œï¼Ÿ
å‹•ã„ã¦ã„ã¾ã›ã‚“ã€‚æ—§ sendLetter.ts ãŒ 1â€¯000èªå˜ä½ã§ç™ºç«ã—ã¦ã„ã¾ã™ã€‚

å¯¾å¿œ: æ—§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç‰©ç†å‰Šé™¤ã—ã€æ–° ProgressWatcher ã§ shouldSendMail/Letter ã‚’å‘¼ã³å‡ºã—ã¦ãã ã•ã„ï¼ˆãƒ‘ãƒƒãƒä¾‹ã¯ä¸‹ã«å†æ²ï¼‰ã€‚

Q2. mail.md ã®èªæ•°åŒºåˆ‡ã‚ŠãŒåˆã‚ãªã„
ä¿®æ­£ä¾‹
src/data/messages/mails/000_tokyo_departure.md

md
ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹
---
id: mail-000
trigger: 300
image: /images/tokyo.png
---
-ï¼ˆæœ¬æ–‡ï¼‰  
src/data/messages/mails/001_tokyo_midflight.md

md
ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹
---
id: mail-001
trigger: 5300
image: /images/tokyo.png
---
-ï¼ˆæœ¬æ–‡ï¼‰
ãƒã‚¤ãƒ³ãƒˆ: trigger å€¤ã‚’ 300, 5300, 10300, 15300, â€¦ ã¨ãƒ•ã‚¡ã‚¤ãƒ«åã«åˆã‚ã›ã¦æ›¸ãã€‚

Letter å´ã¯ 20300, 40300, â€¦ ã‚’ trigger: ã«è¨­å®šã€‚

Q3. ãƒ¡ãƒ¼ãƒ«ãŒå±Šã‹ãªã„
ãƒ•ãƒ­ãƒ³ãƒˆå´ã§ loadMessage('mail', trigger) ãŒ trigger=300/5300â€¦ ã«ä¸€è‡´ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã›ãš undefined â†’ é€ã‚‰ã‚Œã¦ã„ãªã„å¯èƒ½æ€§å¤§ã€‚

å¯¾å¿œ: trigger ã‚’ã‚­ãƒ¼ã«ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢ã€ãªã„å ´åˆã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«è­¦å‘Šã‚’å‡ºã™å®Ÿè£…ã«å¤‰ãˆã‚‹ã¨ãƒ‡ãƒãƒƒã‚°ã—ã‚„ã™ã„ã€‚

Q4. å„ªå…ˆåº¦
æ—§ãƒ­ã‚¸ãƒƒã‚¯å‰Šé™¤ï¼‹æ–°åˆ¤å®šå°å…¥ï¼ˆãƒã‚°å…ƒã‚’æ–­ã¤ï¼‰

ãƒ¡ãƒ¼ãƒ«ï¼æ‰‹ç´™ã®ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã‚’ trigger ãƒ™ãƒ¼ã‚¹ã«å†ä½œæˆ

ç”»åƒãƒ‘ã‚¹ç¢ºèªï¼ˆ/images/tokyo.png ãªã©ï¼‰

UI / UX èª¿æ•´ãƒ»èªå½™ãƒ¬ãƒ™ãƒ«ç”Ÿæˆã¯å¾Œå›ã—ã§ OK

4ï¸âƒ£ æ›´æ–°ãƒ‘ãƒƒãƒï¼ˆå†æ²ãƒ»å¾®èª¿æ•´ç‰ˆï¼‰
4â€‘1. rewardRules.ts
ts
ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹
export function shouldSendMail(total: number): boolean {
  if (total === 300) return true;          // å‡ºç™ºãƒ¡ãƒ¼ãƒ«
  const d = total - 300;
  return d > 0 && [5_000, 10_000, 15_000].includes(d % 20_000);
}

export function shouldSendLetter(total: number): boolean {
  return total >= 20_300 && (total - 20_300) % 20_000 === 0;
}
4â€‘2. ProgressWatcher.tsx
tsx
ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹
if (shouldSendMail(totalWords))   queueEvent({ type: "MAIL", trigger: totalWords });
if (shouldSendLetter(totalWords)) queueEvent({ type: "LETTER", trigger: totalWords });
4â€‘3. ãƒ•ã‚©ãƒ«ãƒ€ä¾‹
bash
ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹
src/data/messages/
â”œâ”€ mails/
â”‚  â”œâ”€ 000_tokyo_departure.md   (trigger: 300)
â”‚  â”œâ”€ 001_tokyo_midflight.md   (5300)
â”‚  â””â”€ ...
â””â”€ letters/
   â”œâ”€ 000_seoul_arrival.md     (20300)
   â”œâ”€ 001_beijing_arrival.md   (40300)
   â””â”€ ...
ğŸš€ æ¬¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¾ã¨ã‚
mail/letter ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸Šè¨˜å‘½åï¼‹ trigger: ã«ä¿®æ­£

æ—§ sendInFlightMail.* / sendLetter.* ã‚’å‰Šé™¤

ProgressWatcher ãŒæ–°ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’å‘¼ã‚“ã§ã„ã‚‹ã‹ç¢ºèª

ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã§ 300â†’5300â†’10300â†’15300â†’20300 ã‚’è¸ã¾ã›ã¦å‹•ä½œç¢ºèª