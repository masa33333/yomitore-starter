<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¡ãƒ¼ãƒ«ãƒ»æ‰‹ç´™ã‚·ã‚¹ãƒ†ãƒ  ãƒ‡ãƒãƒƒã‚°</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .info { background: #e3f2fd; }
        .success { background: #e8f5e9; }
        .warning { background: #fff3e0; }
        .error { background: #ffebee; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .primary { background: #2196F3; color: white; }
        .secondary { background: #FF9800; color: white; }
        .danger { background: #f44336; color: white; }
        input { padding: 8px; margin: 5px; border: 1px solid #ccc; border-radius: 3px; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ± ãƒ¡ãƒ¼ãƒ«ãƒ»æ‰‹ç´™ã‚·ã‚¹ãƒ†ãƒ  ãƒ‡ãƒãƒƒã‚°</h1>
        
        <div class="status info">
            <h3>ğŸ“Š ç¾åœ¨ã®çŠ¶æ³</h3>
            <p>ç¾åœ¨ã®èªæ•°: <strong id="currentWords">èª­ã¿è¾¼ã¿ä¸­...</strong></p>
            <p>ã‚­ãƒ¥ãƒ¼å†…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: <strong id="queueCount">èª­ã¿è¾¼ã¿ä¸­...</strong></p>
        </div>
        
        <div class="status info">
            <h3>ğŸ” ãƒ¡ãƒ¼ãƒ«ãƒ»æ‰‹ç´™åˆ¤å®šãƒ†ã‚¹ãƒˆ</h3>
            <input type="number" id="testWords" placeholder="èªæ•°ã‚’å…¥åŠ›" value="300">
            <button class="primary" onclick="testTriggers()">åˆ¤å®šãƒ†ã‚¹ãƒˆ</button>
            <div id="testResults"></div>
        </div>
        
        <div class="status info">
            <h3>ğŸ“¬ æ‰‹å‹•ãƒ¡ãƒ¼ãƒ«ãƒ»æ‰‹ç´™é€ä¿¡</h3>
            <button class="secondary" onclick="sendTestMail(300)">300èªãƒ¡ãƒ¼ãƒ«é€ä¿¡</button>
            <button class="secondary" onclick="sendTestMail(5300)">5300èªãƒ¡ãƒ¼ãƒ«é€ä¿¡</button>
            <button class="secondary" onclick="sendTestLetter(20300)">20300èªæ‰‹ç´™é€ä¿¡</button>
            <button class="danger" onclick="clearQueue()">ã‚­ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢</button>
        </div>
        
        <div class="status success">
            <h3>ğŸš€ ã‚­ãƒ£ãƒƒãƒã‚¢ãƒƒãƒ—æ©Ÿèƒ½</h3>
            <p>ç¾åœ¨ã®èªæ•°ã«åŸºã¥ã„ã¦ã€éå»ã«é€ä¿¡ã•ã‚Œã‚‹ã¹ãã ã£ãŸãƒ¡ãƒ¼ãƒ«ãƒ»æ‰‹ç´™ã‚’é¡ã£ã¦é€ä¿¡</p>
            <button class="primary" onclick="runCatchup()">ã‚­ãƒ£ãƒƒãƒã‚¢ãƒƒãƒ—å®Ÿè¡Œ</button>
            <button class="secondary" onclick="showExpectedMessages()">æœŸå¾…ã•ã‚Œã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º</button>
            <div id="catchupResults"></div>
        </div>
        
        <div class="status info">
            <h3>ğŸ“‹ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ¥ãƒ¼</h3>
            <button class="primary" onclick="refreshQueue()">ã‚­ãƒ¥ãƒ¼æ›´æ–°</button>
            <div id="queueStatus"></div>
        </div>
        
        <div class="status info">
            <h3>ğŸ› ï¸ èªæ•°æ›´æ–°ãƒ†ã‚¹ãƒˆ</h3>
            <input type="number" id="newWords" placeholder="æ–°ã—ã„èªæ•°" value="500">
            <button class="primary" onclick="updateWords()">èªæ•°æ›´æ–°</button>
            <button class="danger" onclick="resetWords()">èªæ•°ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        
        <div class="status info">
            <h3>ğŸ“ ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</h3>
            <pre id="debugLog"></pre>
        </div>
    </div>

    <script>
        // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
        let debugLog = [];
        function log(message) {
            console.log(message);
            debugLog.push(new Date().toLocaleTimeString() + ': ' + message);
            document.getElementById('debugLog').textContent = debugLog.slice(-10).join('\n');
        }

        // ç¾åœ¨ã®çŠ¶æ³ã‚’å–å¾—
        function getCurrentStatus() {
            const totalWords = parseInt(localStorage.getItem('totalWordsRead') || '0', 10);
            const userProgress = localStorage.getItem('userProgress');
            let progressWords = 0;
            
            if (userProgress) {
                try {
                    const parsed = JSON.parse(userProgress);
                    progressWords = parsed.totalWords || 0;
                } catch (e) {
                    log('userProgressè§£æã‚¨ãƒ©ãƒ¼: ' + e.message);
                }
            }
            
            const actualWords = Math.max(totalWords, progressWords);
            document.getElementById('currentWords').textContent = actualWords + 'èª';
            
            const queue = getMessageQueue();
            document.getElementById('queueCount').textContent = queue.length + 'ä»¶';
            
            log(`ç¾åœ¨ã®èªæ•°: ${actualWords} (totalWordsRead: ${totalWords}, userProgress: ${progressWords})`);
            return actualWords;
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ¥ãƒ¼ã‚’å–å¾—
        function getMessageQueue() {
            try {
                const stored = localStorage.getItem('messageQueue');
                return stored ? JSON.parse(stored) : [];
            } catch (e) {
                log('ã‚­ãƒ¥ãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼: ' + e.message);
                return [];
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ¥ãƒ¼ã‚’æ›´æ–°
        function refreshQueue() {
            const queue = getMessageQueue();
            let html = '<h4>ã‚­ãƒ¥ãƒ¼å†…å®¹:</h4>';
            
            if (queue.length === 0) {
                html += '<p>ã‚­ãƒ¥ãƒ¼ã¯ç©ºã§ã™</p>';
            } else {
                queue.forEach((msg, index) => {
                    html += `<div class="status warning">
                        <strong>${msg.type}</strong> - ${msg.trigger}èª 
                        <small>(${new Date(msg.timestamp).toLocaleTimeString()})</small>
                    </div>`;
                });
            }
            
            document.getElementById('queueStatus').innerHTML = html;
            log(`ã‚­ãƒ¥ãƒ¼æ›´æ–°: ${queue.length}ä»¶ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸`);
        }

        // åˆ¤å®šãƒ†ã‚¹ãƒˆ
        function testTriggers() {
            const words = parseInt(document.getElementById('testWords').value);
            
            // ãƒ¡ãƒ¼ãƒ«åˆ¤å®š
            const shouldSendMail = (totalWords) => {
                if (totalWords === 300) return true;
                const d = totalWords - 300;
                return d > 0 && [5_000, 10_000, 15_000].includes(d % 20_000);
            };
            
            // æ‰‹ç´™åˆ¤å®š
            const shouldSendLetter = (totalWords) => {
                if (totalWords === 1_000_000) return true;
                return totalWords >= 20_300 && (totalWords - 20_300) % 20_000 === 0;
            };
            
            const mailResult = shouldSendMail(words);
            const letterResult = shouldSendLetter(words);
            
            const html = `
                <div class="status ${mailResult ? 'success' : 'warning'}">
                    <strong>${words}èªã§ãƒ¡ãƒ¼ãƒ«é€ä¿¡:</strong> ${mailResult ? 'YES' : 'NO'}
                </div>
                <div class="status ${letterResult ? 'success' : 'warning'}">
                    <strong>${words}èªã§æ‰‹ç´™é€ä¿¡:</strong> ${letterResult ? 'YES' : 'NO'}
                </div>
            `;
            
            document.getElementById('testResults').innerHTML = html;
            log(`åˆ¤å®šãƒ†ã‚¹ãƒˆ ${words}èª: ãƒ¡ãƒ¼ãƒ«=${mailResult}, æ‰‹ç´™=${letterResult}`);
        }

        // ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒ†ã‚¹ãƒˆ
        function sendTestMail(trigger) {
            queueMessage('mail', trigger);
            log(`ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡: ${trigger}èª`);
            refreshQueue();
        }

        // æ‰‹ç´™é€ä¿¡ãƒ†ã‚¹ãƒˆ
        function sendTestLetter(trigger) {
            queueMessage('letter', trigger);
            log(`ãƒ†ã‚¹ãƒˆæ‰‹ç´™é€ä¿¡: ${trigger}èª`);
            refreshQueue();
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
        function queueMessage(type, trigger) {
            try {
                const queue = getMessageQueue();
                const exists = queue.some(msg => msg.type === type && msg.trigger === trigger);
                
                if (!exists) {
                    queue.push({
                        type,
                        trigger,
                        timestamp: Date.now()
                    });
                    localStorage.setItem('messageQueue', JSON.stringify(queue));
                    log(`ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ : ${type} - ${trigger}èª`);
                } else {
                    log(`æ—¢ã«å­˜åœ¨: ${type} - ${trigger}èª`);
                }
            } catch (e) {
                log('ã‚­ãƒ¥ãƒ¼è¿½åŠ ã‚¨ãƒ©ãƒ¼: ' + e.message);
            }
        }

        // ã‚­ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢
        function clearQueue() {
            localStorage.removeItem('messageQueue');
            log('ã‚­ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
            refreshQueue();
        }

        // èªæ•°æ›´æ–°
        function updateWords() {
            const newWords = parseInt(document.getElementById('newWords').value);
            localStorage.setItem('totalWordsRead', newWords.toString());
            
            // userProgressã‚‚æ›´æ–°
            const userProgress = localStorage.getItem('userProgress');
            if (userProgress) {
                try {
                    const parsed = JSON.parse(userProgress);
                    parsed.totalWords = newWords;
                    localStorage.setItem('userProgress', JSON.stringify(parsed));
                } catch (e) {
                    log('userProgressæ›´æ–°ã‚¨ãƒ©ãƒ¼: ' + e.message);
                }
            }
            
            log(`èªæ•°ã‚’${newWords}èªã«æ›´æ–°ã—ã¾ã—ãŸ`);
            getCurrentStatus();
        }

        // èªæ•°ãƒªã‚»ãƒƒãƒˆ
        function resetWords() {
            localStorage.setItem('totalWordsRead', '0');
            
            // userProgressã‚‚æ›´æ–°
            const userProgress = localStorage.getItem('userProgress');
            if (userProgress) {
                try {
                    const parsed = JSON.parse(userProgress);
                    parsed.totalWords = 0;
                    localStorage.setItem('userProgress', JSON.stringify(parsed));
                } catch (e) {
                    log('userProgressæ›´æ–°ã‚¨ãƒ©ãƒ¼: ' + e.message);
                }
            }
            
            log('èªæ•°ã‚’0ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
            getCurrentStatus();
        }

        // ã‚­ãƒ£ãƒƒãƒã‚¢ãƒƒãƒ—å®Ÿè¡Œ
        function runCatchup() {
            const currentWords = getCurrentStatus();
            const result = catchupMessages(currentWords);
            
            const html = `
                <div class="status success">
                    <h4>ã‚­ãƒ£ãƒƒãƒã‚¢ãƒƒãƒ—çµæœ:</h4>
                    <p><strong>ãƒ¡ãƒ¼ãƒ«:</strong> ${result.mailsSent}ä»¶</p>
                    <p><strong>æ‰‹ç´™:</strong> ${result.lettersSent}ä»¶</p>
                    <p><strong>é€ä¿¡ã—ãŸèªæ•°:</strong> ${result.triggers.join(', ')}</p>
                </div>
            `;
            
            document.getElementById('catchupResults').innerHTML = html;
            log(`ã‚­ãƒ£ãƒƒãƒã‚¢ãƒƒãƒ—å®Œäº†: ãƒ¡ãƒ¼ãƒ«${result.mailsSent}ä»¶, æ‰‹ç´™${result.lettersSent}ä»¶`);
            refreshQueue();
        }

        // æœŸå¾…ã•ã‚Œã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showExpectedMessages() {
            const currentWords = getCurrentStatus();
            const expectedMessages = getExpectedMessages(0, currentWords);
            
            let html = '<h4>æœŸå¾…ã•ã‚Œã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</h4>';
            if (expectedMessages.length === 0) {
                html += '<p>æœŸå¾…ã•ã‚Œã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
            } else {
                expectedMessages.forEach(msg => {
                    html += `<div class="status info">
                        <strong>${msg.trigger}èª:</strong> ${msg.type === 'mail' ? 'ãƒ¡ãƒ¼ãƒ«' : 'æ‰‹ç´™'}
                    </div>`;
                });
            }
            
            document.getElementById('catchupResults').innerHTML = html;
        }

        // ã‚­ãƒ£ãƒƒãƒã‚¢ãƒƒãƒ—é–¢æ•°
        function catchupMessages(currentWords) {
            const result = {
                mailsSent: 0,
                lettersSent: 0,
                triggers: []
            };

            const existingQueue = getMessageQueue();
            const existingTriggers = new Set(existingQueue.map(msg => msg.trigger));

            for (let words = 300; words <= currentWords; words++) {
                if (existingTriggers.has(words)) {
                    continue;
                }

                // ãƒ¡ãƒ¼ãƒ«åˆ¤å®š
                if (shouldSendMail(words)) {
                    queueMessage('mail', words);
                    result.mailsSent++;
                    result.triggers.push(words);
                }

                // æ‰‹ç´™åˆ¤å®š
                if (shouldSendLetter(words)) {
                    queueMessage('letter', words);
                    result.lettersSent++;
                    result.triggers.push(words);
                }
            }

            return result;
        }

        // æœŸå¾…ã•ã‚Œã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—
        function getExpectedMessages(startWords, endWords) {
            const messages = [];

            for (let words = startWords; words <= endWords; words++) {
                if (shouldSendMail(words)) {
                    messages.push({ trigger: words, type: 'mail' });
                }
                if (shouldSendLetter(words)) {
                    messages.push({ trigger: words, type: 'letter' });
                }
            }

            return messages.sort((a, b) => a.trigger - b.trigger);
        }

        // ãƒ¡ãƒ¼ãƒ«åˆ¤å®šé–¢æ•°
        function shouldSendMail(totalWords) {
            if (totalWords === 300) return true;
            const d = totalWords - 300;
            return d > 0 && [5_000, 10_000, 15_000].includes(d % 20_000);
        }

        // æ‰‹ç´™åˆ¤å®šé–¢æ•°
        function shouldSendLetter(totalWords) {
            if (totalWords === 1_000_000) return true;
            return totalWords >= 20_300 && (totalWords - 20_300) % 20_000 === 0;
        }

        // åˆæœŸåŒ–
        window.onload = function() {
            getCurrentStatus();
            refreshQueue();
            log('ãƒ‡ãƒãƒƒã‚°ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
        };
    </script>
</body>
</html>